# nilla-utils Architectural Overview

> [!WARNING]
> This entire document is generated by an LLM by feeding the output of [files-to-prompt](https://github.com/simonw/files-to-prompt) to Gemini.

## 1. Introduction

`nilla-utils` (Doc 2) is a collection of [Nilla](https://github.com/nilla-nix/nilla) modules and CLI plugins designed to streamline working with NixOS and Home Manager configurations. It enhances Nilla by providing abstractions for system definitions, generation management, and CLI tools for common system administration tasks.

The project primarily consists of two main parts:
1.  **Nilla Modules**: Nix-based modules that integrate with Nilla's configuration system to define systems, packages, shells, overlays, and inputs, often through "generators" that discover configurations from directory structures.
2.  **CLI Plugins**: Go-based command-line interface tools (`nilla-os` and `nilla-home`) that extend the `nilla` CLI to build, deploy, and manage NixOS and Home Manager systems respectively.

## 2. Core Components

### 2.1. Nilla Modules

Located in the `modules/` directory (Docs 32-39), these Nix files provide the declarative interface for users to define their configurations within a Nilla project.

*   **Purpose**: To extend Nilla's core functionality with specialized support for NixOS and Home Manager, and to simplify common Nix configuration patterns.
*   **Key Features**:
    *   **System Definitions**: Provides `systems.nixos` (defined in Doc 36) and `systems.home` (defined in Doc 33) attributes for declaring NixOS and Home Manager configurations.
    *   **Generators**: A powerful feature allowing Nilla to automatically discover and configure:
        *   `generators.inputs`: Nilla inputs from `npins` files (defined in Doc 34).
        *   `generators.packages`: Nix packages from a specified folder (defined in Doc 38).
        *   `generators.shells`: Development shells from a specified folder (defined in Doc 39).
        *   `generators.overlays`: Nixpkgs overlays from a specified folder (defined in Doc 37).
        *   `generators.nixos`: NixOS systems from a directory of host configurations (defined in Doc 36).
        *   `generators.home`: Home Manager configurations from a directory of user/host configurations (defined in Doc 33).
    *   **Helper Utilities**: `modules/lib.nix` (Doc 35) provides common Nix functions for loading configurations from directories, used by the generators.

### 2.2. CLI Plugins (`nilla-os` and `nilla-home`)

These are Go applications (built by `package.nix`, Doc 3) that act as plugins for the `nilla` CLI, providing subcommands like `nilla os ...` and `nilla home ...`.

*   **Purpose**: To offer a user-friendly interface for managing the lifecycle of NixOS and Home Manager systems defined within a Nilla project.
*   **Source Code**: Located in `cmd/nilla-os/` (Docs 10, 11) and `cmd/nilla-home/` (Docs 8, 9).
*   **Key Functionalities**:
    *   Building configurations (`build`).
    *   Activating configurations (`switch`, `test`, `boot` for NixOS).
    *   Listing available configurations in a project (`list`).
    *   Managing system generations (`generations list`, `generations clean`).
    *   Comparing changes between generations using `nvd` or internal diffing logic (Doc 30).
    *   Support for local and remote (SSH) system updates.
    *   Interactive TUI for progress display and confirmations.

## 3. Detailed Architecture

### 3.1. CLI Plugins

The CLI plugins are built using Go and leverage several internal packages for their functionality.

#### 3.1.1. Command Structure & Entry Points

*   **Framework**: Uses `urfave/cli/v3` (dependency in Doc 4) for command-line argument parsing and subcommand organization.
*   **Main Files**: `cmd/nilla-os/main.go` (Doc 11) and `cmd/nilla-home/main.go` (Doc 9) define the CLI commands, flags, and actions.
*   **Subcommands**:
    *   `nilla-os`: `build`, `test`, `boot`, `switch`, `list`, `generations` (Doc 11).
    *   `nilla-home`: `build`, `switch`, `list`, `generations` (Doc 9).

#### 3.1.2. Project Resolution (`internal/project`)

*   **Purpose**: To locate and interpret the Nilla project specified by the user (Doc 29).
*   **Mechanism**:
    *   Resolves various URI schemes: local paths (`./`, `/`, `~`), `path:`, `github:owner/repo`, `gitlab:owner/repo`.
    *   For local paths, it can search up the directory tree for `nilla.nix`.
    *   If a project is in a Git repository, it uses `nix.AddGitPathToStore` (from Doc 14) to ensure a clean, store-based representation. Otherwise, `nix.AddPathToStore` is used.
    *   Returns a `ProjectSource` struct containing store path, hash, and relative path to `nilla.nix`.

#### 3.1.3. Nix Interaction (`internal/nix`)

*   **Nix Command Execution (`internal/nix/nix.go`, Doc 12)**:
    *   Provides a `NixCommand` builder for constructing and running Nix commands (e.g., `nix build`, `nix eval`).
    *   Supports privileged execution (`sudo nix ...`).
    *   Can capture stdout/stderr.
*   **Progress Parsing (`internal/nix/progress.go`, Doc 13)**:
    *   A `ProgressDecoder` parses Nix's `--log-format internal-json` output from stderr.
    *   Decodes various event types (start, stop, result, messages) related to builds, copies, and transfers.
    *   Used by the TUI to display real-time progress.
*   **Nix Store Operations (`internal/nix/store.go`, Doc 14)**:
    *   Functions to add local paths or Git repositories to the Nix store (`AddPathToStore`, `AddGitPathToStore`).
    *   Retrieves store path hashes (`GetStoreHash`).
    *   Lists attributes within a Nilla project (`ListAttrsInProject`) or checks for their existence (`ExistsInProject`) by evaluating Nix expressions against the project's store path.
    *   Fetches Git repositories using `builtins.fetchGit` via Nix evaluation (`FetchGit`).

#### 3.1.4. Execution Model (Local & Remote) (`internal/exec`)

*   **Abstraction**: An `Executor` interface defines how commands are run (Doc 25).
*   **Local Execution (`internal/exec/local.go`, Doc 26)**:
    *   A `localExecutor` uses Go's standard `os/exec` package.
*   **SSH Execution (`internal/exec/ssh.go`, Doc 27)**:
    *   A `sshExecutor` allows commands to be run on remote hosts.
    *   Parses SSH targets (e.g., `user@host:port`).
    *   Uses `~/.ssh/config` for host configurations (port, user, identity files).
    *   Supports agent forwarding and private key authentication.
    *   Handles PTY allocation for `sudo` commands if stdin is a terminal.

#### 3.1.5. System Generation Management (`internal/generation`)

*   **Purpose**: To inspect and manage NixOS and Home Manager generations.
*   **NixOS Generations (`internal/generation/nixos.go`, Doc 24)**:
    *   Locates the current NixOS system profile (`/nix/var/nix/profiles/system`).
    *   Lists all available NixOS generations by reading symlinks in `/nix/var/nix/profiles` (e.g., `system-*-link`).
    *   Parses generation metadata (ID, build date, NixOS version, kernel version).
    *   Provides functionality to delete generation symlinks.
*   **Home Manager Generations (`internal/generation/home.go`, Doc 23)**:
    *   Locates the current Home Manager profile (checks `/nix/var/nix/profiles/per-user/$USER/home-manager` and `~/.local/state/nix/profiles/home-manager`).
    *   Lists available Home Manager generations.
    *   Parses generation metadata (ID, build date, Home Manager version).
    *   Provides functionality to delete generation symlinks.
*   **Cleaning**: The `generations clean` commands (Docs 8, 10) use these functionalities to identify old generations to remove and then trigger `nix store gc`.

#### 3.1.6. System Diffing (`internal/diff`)

*   **Purpose**: To compare two system generations, typically the current one and a newly built one (Doc 30).
*   **Mechanism**:
    *   For local-only comparisons, it can invoke `nvd diff`.
    *   For other cases (e.g., remote targets or more detailed analysis), it performs its own diffing:
        *   Queries Nix store references and requisites for each generation to get a list of store paths.
        *   Parses these paths into `Package` structs (name, version, path).
        *   Builds `PackageSet`s for "before" and "after" states.
        *   Calculates differences: changed versions, added packages, removed packages.
        *   Calculates closure size differences (`BytesBefore`, `BytesAfter`) using `nix path-info --closure-size`.
    *   Prints a summary of these changes.

#### 3.1.7. Terminal User Interface (TUI) (`internal/tui`)

*   **Framework**: Built with `charmbracelet/bubbletea` and related libraries (bubbles, lipgloss) (dependencies in Doc 4).
*   **Progress Reporting**:
    *   `BuildReporter` (Doc 16) and `CopyReporter` (Doc 18) display progress for Nix builds and store path copies.
    *   They consume events from `nix.ProgressDecoder` (Doc 13) and update the TUI model (Doc 19).
    *   Show active tasks, overall progress (done/expected/running), and byte transfer rates.
    *   Support verbose mode for detailed log output.
*   **Confirmations (`internal/tui/confirm.go`, Doc 17)**:
    *   Provides a simple `[y/n]` prompt for actions requiring user confirmation (e.g., before switching configurations or cleaning generations).
*   **General Utilities (`internal/util`)**:
    *   Logging setup (`InitLogger`) with configurable verbosity and styled output (Doc 21).
    *   Byte conversion utilities for human-readable sizes (`ConvertBytes`, Doc 21).
    *   Table rendering (`RenderTable`, Doc 20).
    *   User/homedir information and privilege escalation (`SelfElevate`, Doc 21).

### 3.2. Nilla Modules

These modules are the declarative backbone, defining how Nilla understands and manages various Nix constructs.

#### 3.2.1. Configuration Abstraction

*   They define Nilla options (e.g., `config.systems.nixos`, `config.generators.packages`).
*   Users configure these options in their `nilla.nix` file (examples in Docs 2, 42, 43, 44).
*   The modules then translate these configurations into actual Nix derivations or attribute sets.

#### 3.2.2. Generators

*   **Core Idea**: Simplify configuration by convention over explicit declaration. Generators scan specified directories for Nix files (e.g., `default.nix`, `configuration.nix`, `home.nix`) or use existing tools like `npins`.
*   **`generators.inputs` (Doc 34)**: Creates Nilla `config.inputs` from an `npins` attribute set (typically from `npins/default.nix`, Doc 40).
*   **`generators.packages` (Doc 38)**, **`generators.shells` (Doc 39)**, **`generators.overlays` (Doc 37)**: Scan a folder (e.g., `./packages`) for subdirectories, each containing a `default.nix`. These are then exposed under `config.packages.*`, `config.shells.*`, or `config.overlays.*`.
*   **`generators.nixos` (Doc 36)**: Scans a folder (e.g., `./hosts`) for subdirectories representing NixOS hosts. Each host directory is expected to contain a `configuration.nix`. These are then exposed under `config.systems.nixos.*`.
*   **`generators.home` (Doc 33)**: Similar to `generators.nixos`, but looks for `home.nix` files and populates `config.systems.home.*`.

#### 3.2.3. Helper Utilities (`modules/lib.nix`, Doc 35)

*   Provides Nix functions like `loadDirsCond`, `loadDirsWithFile`, and `loadHostsFromDir` which are used by the generators to discover and load Nix files from the filesystem based on specific criteria.

## 4. Build and Packaging

*   **CLI Plugins**:
    *   The Go applications (`nilla-os`, `nilla-home`) are built using `buildGoApplication` from Nixpkgs (as seen in `nilla-utils/package.nix`, Doc 3).
    *   Go module dependencies are managed by `go.mod` (Doc 4) and `go.sum` (Doc 5), and translated to Nix derivations via `gomod2nix` (using `gomod2nix.toml`, Doc 6).
    *   The `nilla-utils` project itself has a `nilla.nix` (Doc 7) that defines a `packages.nilla-utils-plugins` output, which builds these Go CLIs.
*   **Nilla Modules**: Being Nix code, they are directly imported by user's Nilla configurations.
*   **Nix Dependencies**: Managed by `npins` (config in `npins/default.nix`, Doc 40, and sources in `npins/sources.json`, Doc 41), which pins versions of `nilla`, `nixpkgs`, `gomod2nix`, etc.

## 5. Technology Stack

*   **Nix**: For Nilla modules, package definitions, and the underlying configuration management.
*   **Go**: For the CLI plugins (`nilla-os`, `nilla-home`).
*   **Nilla**: The framework upon which `nilla-utils` builds.
*   **Shell**: Used in example quickstart (Doc 2) and for some basic scripting.
*   **Key Go Libraries** (from `go.mod`, Doc 4):
    *   `github.com/urfave/cli/v3`: CLI framework.
    *   `github.com/charmbracelet/*` (bubbletea, bubbles, lipgloss, log): TUI and logging.
    *   `golang.org/x/crypto/ssh`: SSH client implementation.
    *   `github.com/kevinburke/ssh_config`, `github.com/skeema/knownhosts`: SSH configuration parsing.

## 6. Directory Structure Highlights

*   `cmd/`: Source code for the Go CLI plugins.
    *   `nilla-home/` (Docs 8, 9): Home Manager CLI plugin.
    *   `nilla-os/` (Docs 10, 11): NixOS CLI plugin.
*   `internal/`: Internal Go packages shared by the CLI plugins.
    *   `diff/` (Doc 30): System generation diffing logic.
    *   `exec/` (Docs 25-27): Command execution abstraction (local, SSH).
    *   `generation/` (Docs 23, 24): NixOS/Home Manager generation data structures and logic.
    *   `nix/` (Docs 12-14): Nix command interaction, progress parsing, store operations.
    *   `project/` (Doc 29): Nilla project URI resolution.
    *   `tui/` (Docs 16-19): Terminal User Interface components.
    *   `util/` (Docs 20, 21): General utility functions.
*   `modules/` (Docs 32-39): Nilla modules (Nix files).
*   `examples/` (Docs 42-46): Example Nilla configurations demonstrating `nilla-utils` features.
*   `package.nix` (Doc 3): Top-level Nix file for building the Go CLI plugins as a Nix package.
*   `nilla.nix` (Doc 7): Nilla project file for `nilla-utils` itself.
*   `go.mod` (Doc 4), `go.sum` (Doc 5), `gomod2nix.toml` (Doc 6): Go dependency and Nix build information.
*   `npins/` (Docs 40, 41): Npins managed Nix dependencies.
